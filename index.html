<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>
    <title>Dow Jones Historical Data</title>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            color: #292929;
            font: 90% Roboto, Arial, sans-serif;
            font-weight: 300;
            width:1200px;
        }

        p {
            padding: 0 10px;
            line-height: 1.8;
        }

        ul li {
            padding-right: 10px;
            line-height: 1.6;
        }

        h3 {
            padding: 5px 20px;
            margin: 0;
        }

        div#header {
            position: relative;
        }

        div#header h1 {
            height: 80px;
            line-height: 80px;
            margin: 0;
            padding-left: 10px;
            background: #e0e0e0;
            color: #292929;
        }

        div#header a {
            position: absolute;
            right: 0;
            top: 23px;
            padding: 10px;
            color: #006;
        }

        div#navigation {
            background: white;

        }

        div#navigation li {
            list-style: none;
        }

        div#extra {
            background:white;
        }

        div#footer {
            background: #42444e;
            color: #fff;
        }

        div#footer p {
            padding: 20px 10px;
        }

        div#wrapper {
            float: left;
            width: 100%;
        }

        div#content {
            margin-left: 300px;
        }

        div#navigation {
            float: left;
            width: 200px;
            margin-left: -100%;
        }

        div#extra {
            clear: left;
            width: 100%;
        }

        #description{
          width:300px
        }
        div.tooltip {
          position: absolute;
          text-align: center;
          width: 140px;
          height: 50px;
          padding: 2px;
          font: 12px sans-serif;
          background: lightgreen;
          border: 0px;
          border-radius: 8px;
          pointer-events: none;
        }

    </style>

</head>
<body>
<div id="container">
    <div id="header">
        <h1>Dow Jones Historical Index 1915-2021</h1>
    </div>
    <div id="wrapper">
        <div id="content">
          <svg id="main_svg" width=700 height=400></svg>
        </div>
    </div>
    <div id="navigation">
        <H2><strong>Historical Events</strong></H2>

        <ul>
            <button id="btn_1" onClick="init(1)">World War I</button>
            <button id="btn_2" onClick="init(2)">Great Depression</button>
            <button id="btn_3" onClick="init(3)">World War II</button>
            <button id="btn_4" onClick="init(4)">Dot-com Bubble</button>
            <button id="btn_5" onClick="init(5)">2008 Recession</button>
        </ul>
        <H2>Description</H2>
          <p id="description">Replace Me Text</p>
    </div>
    <div id="extra">
        <H2><strong>Timeline Overview</strong></H2>
        <svg id="overview" width=1000 height=300>
          </svg>
    </div>
</div>
<body onload='init()'>
<script>

    var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity",0);
    var parseTime = d3.timeParse("%Y-%m-%d");
    var margin = {top: 20, right: 20, bottom: 50, left: 70},
        width = 960 - margin.left - margin.right,
        height = 200 - margin.top - margin.bottom;
    var x = d3.scaleTime().range([0, width]);
    var y = d3.scaleLinear().range([height, 0]);
    var svg = d3.select("#overview")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform","translate(" + margin.left + "," + margin.top + ")");


    var margin_main = {top: 20, right: 20, bottom: 50, left: 70},
        width_main = 700 - margin.left - margin.right,
        height_main = 600 - margin.top - margin.bottom;
    var x_main = d3.scaleTime().range([0, width_main]);
    var y_main = d3.scaleLinear().range([height_main, 0]);
    var svg_main = d3.select("#main_svg")
            .attr("width", width_main + margin_main.left + margin_main.right)
            .attr("height", height_main + margin_main.top + margin_main.bottom)
            .append("g")
            .attr("transform","translate(" + margin_main.left + "," + margin_main.top + ")");


    var ww1_start = JSON.stringify(parseTime("1915-01-01"));
    var ww1_end = JSON.stringify(parseTime("1921-11-01"));
    var gd_start = JSON.stringify(parseTime("1929-08-01"));
    var gd_end = JSON.stringify(parseTime("1933-03-01"));
    var ww2_start = JSON.stringify(parseTime("1939-09-01"));
    var ww2_end = JSON.stringify(parseTime("1945-09-01"));
    var dotcom_start = JSON.stringify(parseTime("1995-01-01"));
    var dotcom_end = JSON.stringify(parseTime("2003-01-01"));
    var recession2008_start = JSON.stringify(parseTime("2007-1-01"));
    var recession2008_end = JSON.stringify(parseTime("2010-06-01"));
    var data_selected = [];

    var recession2008Points = ["2007-10-01","2008-02-01", "2008-03-01", "2008-09-01", "2009-01-01", "2009-03-01", "2009-06-01" ]
    var recessionTooltips = ["US stock market hit all time high", "George W. Bush sign Economic Stimulus Act of 2008",
  "Bear Sterns collapses and purchased by JPMorgan Chase",  "US Treasury take over management of Freddie Mac",
  "Lehman Brothers declares bankruptcy. $619 billion in debts", "US government bailed out Bank of America",
  "Dow drop more than 50% from all time high"];
    function change_description(selection) {
      if(selection==1)
        document.getElementById("description").innerHTML = "This is WW1"
      if(selection==2)
        document.getElementById("description").innerHTML = "This is Great Depression"
      if(selection==3)
        document.getElementById("description").innerHTML = "This is WW2"
      if(selection==4)
        document.getElementById("description").innerHTML = "This is Great Dot-com bubble"
      if(selection==5)
        document.getElementById("description").innerHTML = "The main cause of the 2008 Recession, also"+
        "known as The Great Recession, was caused by subprime mortage crisis."+
        "These mortages are home lones granted to those who have poor credit histories."+
        "In addition to subprime mortages, as millions of new homes flooded the market,"+
        "the housing market started to decline and many homeowners and mortage lenders"+
        "were in trouble because the value of their homes were less than their total loam amount."+
        "Thus, homeowners couldn't repay their loans, and mortage lenders went bankrupt, leading to recession."
    }

    function main_view(data_zoom, selection) {
      d3.select("#main_svg_ID").remove();
      d3.select("#main_bottom_axis").remove();
      d3.select("#main_left_axis").remove();
      console.log("main");
      var valueline_main = d3.line()
          .x(function(d) { return x_main(d.date); })
          .y(function(d) { return y_main(d.real); });

      x_main.domain(d3.extent(data_zoom, function(d) { return d.date; }));
      y_main.domain([d3.min(data_zoom, function(d) { return d.real; })-500, d3.max(data_zoom, function(d) { return d.real; })]);

      svg_main.append("path")
        .data([data_zoom])
        .attr("class", "line")
        .attr("d", valueline_main)
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("opacity",1)
        .attr("stroke-width", "2px")
        .attr("id", "main_svg_ID");

      // Add the x Axis
      svg_main.append("g")
          .attr("transform", "translate(0," + height_main + ")")
          .attr("id", "main_bottom_axis")
          .call(d3.axisBottom(x_main));

      // Add the y Axis
      svg_main.append("g")
          .attr("id", "main_left_axis")
          .call(d3.axisLeft(y_main));

      if(selection==5) {
        var points = recession2008Points;
        var pointsPosition = [];
        for(var i=0; i<points.length; i++) {
          points[i] = JSON.stringify(parseTime(points[i]));
          for(var j=0; j<data_zoom.length; j++) {
            var cur = JSON.stringify(data_zoom[j].date)
            if(points[i]==cur) {
              pointsPosition.push(data_zoom[j]);
            }
          }
        }
      //  console.log(pointsPosition + "this is position")
      //  for(var a=0; a<pointsPosition.length; a++) {
          svg_main.selectAll("circle")
            .data(pointsPosition).enter().append("circle")
            .attr("cx", function(d){return x_main(d.date);})
            .attr("cy", function(d){return y_main(d.real);})
            .attr("fill", "lime")
            .attr("r",7)
            .on("mouseover", function(d,i){
              d3.select(this).transition()
                .duration("50")
                .attr("opacity", "0.5")
                .attr("fill", "blue")
                .attr("r", "13");

                div.html(recessionTooltips[i])
                  .transition()
                  .duration(50)
                  .style("opacity",1)
                  .style("left", (d3.event.pageX+10) + "px")
                  .style("top", (d3.event.pageY-15) + "px");
            })
            .on("mouseout", function (d, j) {
              d3.select(this).transition()
                .duration('50')
                .attr('opacity', '1')
                .attr("fill", "lime")
                .attr("r","7");

                div.transition()
                    .duration(50)
                    .style("opacity",0);
            });

        //}
        }

    }

    function init(selection) {
      d3.select("#overview_svg_ID").remove();
      d3.select("#overview_svg_selected_ID").remove();
      // define the line
      var valueline = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y(d.real); });

      data_selected = [];

      // Get the data
      d3.csv("https://raw.githubusercontent.com/charleyarby/charleyarby.github.io/main/DJIA_Monthly_Data.csv")
      .then(function(data) {

      //  format the data
        data.forEach(function(d) {
            d.date = parseTime(d.date);
            d.real = +d.real;
        });


        // Scale the range of the data
        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain([0, d3.max(data, function(d) { return d.real; })]);


        var copy = false;
        var endcopy = false;
        var start,end;

        if(selection==1) {
          start = ww1_start;
          end = ww1_end;
        } else if (selection==2) {
          start = gd_start;
          end = gd_end;
        } else if (selection==3) {
          start = ww2_start;
          end = ww2_end;
        } else if (selection==4) {
          start = dotcom_start;
          end = dotcom_end;
        } else if (selection==5) {
          start = recession2008_start;
          end = recession2008_end;
        }

        for(var i=0; i<data.length; i++) {
            var cur = JSON.stringify(data[i].date)
            if(cur==start) {
              copy = true;
              console.log("true")
            }
            if(cur==end)
              endcopy = true;

            if(copy)
              data_selected.push(data[i])
            if(endcopy==true)
              break;
        }


        if(selection) {
          svg.append("path")
            .data([data_selected])
            .attr("class", "line")
            .attr("d", valueline)
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("opacity",1)
            .attr("stroke-width", "5px")
            .attr("id", "overview_svg_selected_ID");
        }
        // Add the valueline path.
        svg.append("path")
            .data([data])
            .attr("class", "line")
            .attr("d", valueline)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("opacity",0.25)
            .attr("stroke-width", "2px")
            .attr("id", "overview_svg_ID");

        // Add the x Axis
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        // Add the y Axis
        svg.append("g")
            .call(d3.axisLeft(y));


        main_view(data_selected, selection);
        change_description(selection);
      });
    }
</script>
</body>
</html>
